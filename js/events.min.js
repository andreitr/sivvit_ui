if(typeof SIVVIT=="undefined")SIVVIT={};SIVVIT.Settings={host:"http://sivvit.com"};(function(jQuery,SIVVIT){SIVVIT.Events={collection:null,view:null,edit:true,init:function(json){var self=this;this.collection=new SIVVIT.EventsCollection;this.view=new SIVVIT.EventsView({edit:this.edit});var MyModel=Backbone.Model.extend({url:json});var tmpModel=new MyModel;tmpModel.bind("change",function(){$("#content-loader").remove();$("#event-application").show();$.each(this.attributes,function(index,value){var actual_model=new SIVVIT.EventModel(value);self.collection.add(actual_model)});self.view.model=
self.collection;self.view.render()});tmpModel.fetch()}};SIVVIT.EventsCollection=Backbone.Collection.extend({model:SIVVIT.EventModel,comparator:function(itm){return-itm.get("startDate")}});SIVVIT.EventsView=Backbone.View.extend({template:"<li id='post-list'><div id='content'><div id='histogram'></div><div id='title'><a href='${link}'>${title}</a></div><div id='description'>${description}</div><div id='meta'>${posts} posts, ${images} images, ${videos} videos &nbsp; &nbsp;<span class='icon-location'></span>${location} &nbsp;<span class='icon-user'></span><a href='#'>${author}</a></div></div></div></li>",
el:"#dynamic-content",models_hash:{},edit:false,displayed:false,initialize:function(options){this.edit=options.edit},render:function(){$(this.el).empty();this.displayed=false;this.display()},display:function(){$(this.el).append("<ol id='event-list'></ol>");this.model.each(function(itm){itm=this.buildTemplate(itm);var mdl=new SIVVIT.TemporalModel({startDate:itm.model.get("startDate"),endDate:itm.model.get("last_update"),startRange:itm.model.get("startDate"),endRange:itm.model.get("last_update"),resolution:itm.model.get("histogram").resolution});
mdl.set({"histogram":itm.model.get("histogram").global});var histogram=(new SIVVIT.HistogramView({el:$(itm.html).find("#histogram"),model:mdl})).render();this.initItem(itm,"#event-list");this.models_hash[itm.model.get("id")]=itm},this);this.initLightbox()},buildTemplate:function(itm){var html=$.tmpl(this.template,{link:SIVVIT.Settings.host+"/event/"+itm.get("id"),title:itm.get("title"),description:itm.get("description"),posts:itm.get("stats").posts,videos:itm.get("stats").videos,images:itm.get("stats").images,
location:itm.get("location").name,author:itm.get("author")});return{html:html,model:itm}},initItem:function(itm,parent){var self=this;if(itm!==null){if(this.edit){itm.html.find("#content").prepend('<span class="item-edit"><span class=\'icon-cog\' href="event_form.html?id='+itm.model.get("id")+'" id=\'event-form\'></span><div id="pending-flag"></div></span>');itm.html.find("#event-form").hide();if(itm.model.get("pending")>0)itm.html.find("#title").append("<div id='pending'>pending "+itm.model.get("pending")+
"</div>");itm.html.hover(function(event){itm.html.find("#event-form").show()},function(event){itm.html.find("#event-form").hide()});itm.html.click(function(event){var checked;if(event.target.id!=="event-form"){if(itm.html.find("#itm-check").length>0){checked=itm.html.find("#itm-check").is(":checked");itm.html.find("#itm-check").attr("checked",!checked);itm.html.css("background-color",checked?"#FFFFFF":"#FFFFCC")}event.stopPropagation()}});this.toggleLive(itm)}$(parent).append(itm.html)}},initLightbox:function(){var self=
this;$("#event-form").fancybox({width:860,height:430,autoScale:true,scrolling:false,transitionIn:"fade",transitionOut:"fade",type:"iframe",afterClose:function(){var cookie=JSON.parse($.cookie("com.sivvit.event"));if(cookie)switch(cookie.action){case "delete":if(self.models_hash[cookie.model.id])self.deleteItem(self.models_hash[cookie.model.id]);break;case "update":if(self.models_hash[cookie.model.id]){self.models_hash[cookie.model.id].model.set(cookie.model);self.updateItem(self.models_hash[cookie.model.id])}break;
case "create":var new_model=new SIVVIT.EventModel(cookie.model);new_model.set({last_update:new_model.get("startDate"),histogram:[]});self.model.add(new_model);self.render();break}$.cookie("com.sivvit.event",null)}})},deleteItem:function(itm){itm.html.fadeOut();this.model.remove(itm.model,{silent:true})},updateItem:function(itm){itm.html.find("#title").html("<a href='"+SIVVIT.Settings.host+"/event/"+itm.model.get("id")+"'>"+itm.model.get("title")+"</a>");itm.html.find("#description").html(itm.model.get("description"));
this.toggleLive(itm)},toggleLive:function(itm){var flag=itm.html.find("#pending-flag");if(itm.model.get("status")===1){flag.toggleClass("idle-notice",false);flag.toggleClass("live-notice",true)}else{flag.toggleClass("idle-notice",true);flag.toggleClass("live-notice",false)}}})})($,SIVVIT);Date.prototype.format=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+String(this.getFullYear()).substr(2,2)+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()};Date.secondsToDate=function(seconds){return new Date(seconds*1E3)};Date.dateToSeconds=function(date){return Math.round(date.getTime()/1E3)};Date.plusSecond=function(date){if(date.getSeconds()===59)return Date.plusMinute(new Date(date.setSeconds(0)));else return new Date(date.setSeconds(date.getSeconds()+1))};
Date.plusMinute=function(date){if(date.getMinutes()===59)return Date.plusHour(new Date(date.setMinutes(0)));else return new Date(date.setMinutes(date.getMinutes()+1))};Date.plusHour=function(date){if(date.getHours()===23)return Date.plusDay(new Date(date.setHours(0)));else return new Date(date.setHours(date.getHours()+1))};
Date.plusDay=function(date){if(date.getDate()===Date.daysInMonth(date.getMonth(),date.getFullYear()))return Date.plusMonth(new Date(date.setDate(1)));else return new Date(date.setDate(date.getDate()+1))};Date.plusMonth=function(date){if(date.getMonth()===11)return Date.plusYear(new Date(date.setMonth(0)));else return new Date(date.setMonth(date.getMonth()+1))};Date.plusYear=function(date){return new Date(new Date(date.setFullYear(date.getFullYear()+1)))};
Date.minusSecond=function(date){if(date.getSeconds()===0)return Date.minusMinute(new Date(date.setSeconds(59)));else return new Date(date.setSeconds(date.getSeconds()-1))};Date.minusMinute=function(date){if(date.getMinutes()===0)return Date.minusHour(new Date(date.setMinutes(59)));else return new Date(date.setMinutes(date.getMinutes()-1))};Date.minusHour=function(date){if(date.getHours()===0)return Date.minusDay(new Date(date.setHours(23)));else return new Date(date.setHours(date.getHours()-1))};
Date.minusDay=function(date){if(date.getDate()===1)return Date.minusMonth(new Date(date.setDate(Date.daysInMonth(date.getMonth(),date.getFullYear()))));else return new Date(date.setDate(date.getDate()-1))};Date.minusMonth=function(date){if(date.getMonth()===0)return Date.minusYear(new Date(date.setMonth(11)));else return new Date(date.setMonth(date.getMonth()-1))};Date.minusYear=function(date){return new Date(new Date(date.setFullYear(date.getFullYear()-1)))};
Date.daysInMonth=function(m,y){return 32-(new Date(y,m,32)).getDate()};SIVVIT.TemporalFrameModel=Backbone.Model.extend({defaults:{count:null,timestamp:null},set:function(attributes,options){if(attributes.hasOwnProperty("count")&&attributes.count!==undefined&&attributes.count!==null)attributes.count=Number(attributes.count);Backbone.Model.prototype.set.call(this,attributes,options);return this}});SIVVIT.TemporalModel=Backbone.Model.extend({defaults:{startDate:new Date,endDate:new Date,startRange:null,endRange:null,min:null,max:null,histogram:null,histogramStartDate:null,histogramEndDate:null,resolution:null},set:function(attributes,options){if(attributes.hasOwnProperty("histogram")&&attributes.histogram!==undefined&&attributes.histogram!==null){this.set({histogramStartDate:null});this.set({histogramEndDate:null});var len=attributes.histogram.length;if(len>0){var tmp_min=0,tmp_max=0;for(var i=
len;i--;){if(attributes.histogram[i].timestamp instanceof Date===false)attributes.histogram[i].timestamp=Date.secondsToDate(attributes.histogram[i].timestamp);if(this.checkDateBounds(attributes.histogram[i].timestamp)===true){tmp_min=Math.min(tmp_min,attributes.histogram[i].count);tmp_max=Math.max(tmp_max,attributes.histogram[i].count);if(!this.get("histogramStartDate")||!this.get("histogramEndDate")){this.set({histogramStartDate:attributes.histogram[i].timestamp});this.set({histogramEndDate:attributes.histogram[i].timestamp})}else{this.set({histogramStartDate:Math.min(attributes.histogram[i].timestamp,
this.get("histogramStartDate"))});this.set({histogramEndDate:Math.max(attributes.histogram[i].timestamp,this.get("histogramEndDate"))})}}else attributes.histogram.splice(i,1)}attributes.min=tmp_min;attributes.max=tmp_max}this.trigger("change:histogram",this,this.get("histogram"),options)}Backbone.Model.prototype.set.call(this,attributes,options);return this},adjustResolution:function(date){switch(this.get("resolution")){case "day":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),
0,0,0);case "hour":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),0,0);case "minute":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes());case "second":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds())}},adjustToNextBucket:function(date,resolution){resolution=resolution===undefined?this.get("resolution"):resolution;switch(resolution){case "day":return Date.plusDay(this.adjustResolution(date));
case "hour":return Date.plusHour(this.adjustResolution(date));case "minute":return Date.plusMinute(this.adjustResolution(date));case "second":return Date.plusSecond(this.adjustResolution(date))}},adjustToPrevBucket:function(date,resolution){resolution=resolution===undefined?this.get("resolution"):resolution;switch(resolution){case "day":return Date.minusDay(this.adjustResolution(date));case "hour":return Date.minusHour(this.adjustResolution(date));case "minute":return Date.minusMinute(this.adjustResolution(date));
case "second":return Date.minusSecond(this.adjustResolution(date))}},getResolution:function(){switch(this.get("resolution")){case "day":return 864E5;case "hour":return 36E5;case "minute":return 6E4;case "second":return 1E3}},checkDateBounds:function(date){return this.adjustToPrevBucket(date,this.get("resolution"))>=this.get("startDate")&&date<=this.get("endDate")?true:false}});SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,pull:true,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:null,endDate:null,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},fetch_interval:null,parse:function(resp,xhr){if(this.get("status")===
1||this.get("status")===0&&this.get("pull")===true)this.startLiveData();else this.stopLiveData();return resp},fetch:function(options){this.stopLiveData();Backbone.Model.prototype.fetch.call(this,options)},set:function(attributes,options){if(attributes.hasOwnProperty("status")&&attributes.status!==undefined&&attributes.status!==null)attributes.status=Number(attributes.status);if(attributes.hasOwnProperty("startDate"))attributes.startDate=Date.secondsToDate(attributes.startDate);if(attributes.hasOwnProperty("endDate"))attributes.endDate=
Date.secondsToDate(attributes.endDate);if(attributes.hasOwnProperty("last_update"))attributes.last_update=Date.secondsToDate(attributes.last_update);if(attributes.hasOwnProperty("histogram")&&attributes.histogram!==undefined&&attributes.histogram!==null){this.attributes.post_hash=this.attributes.post_hash||{};this.attributes.media_hash=this.attributes.media_hash||{};this.attributes.global_hash=this.attributes.global_hash||{};if(this.get("histogram")!==undefined){attributes.histogram.max=Math.max(attributes.histogram.max,
this.get("histogram").max);attributes.histogram.min=Math.min(attributes.histogram.min,this.get("histogram").min)}if(attributes.histogram.post!==undefined&&attributes.histogram.post!==null)attributes.histogram.post=this.appendHistogram(this.get("post_hash"),attributes.histogram.post);if(attributes.histogram.media!==undefined&&attributes.histogram.media!==null)attributes.histogram.media=this.appendHistogram(this.get("media_hash"),attributes.histogram.media);if(attributes.histogram.global!==undefined&&
attributes.histogram.global!==null)attributes.histogram.global=this.appendHistogram(this.get("global_hash"),attributes.histogram.global)}Backbone.Model.prototype.set.call(this,attributes,options);return this},createEvent:function(init){var self=this;init=init||{success:null,error:null};$.ajax({url:SIVVIT.Settings.host+"/e/event/",data:self.formatModel(),type:"POST",dataType:"json",success:init.success,complete:function(data){$.cookie("com.sivvit.event",JSON.stringify({action:"create",model:JSON.parse(data.responseText)}))},
error:init.error})},deleteEvent:function(init){var self=this;init=init||{success:null,complete:null,error:null};$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:self.formatModel(),type:"DELETE",dataType:"json",complete:init.complete,error:init.error});$.cookie("com.sivvit.event",JSON.stringify({action:"delete",model:self.formatModel()}))},updateEvent:function(init){var self=this;init=init||{success:null,error:null};$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:self.formatModel(),
type:"PUT",dataType:"json",success:init.success,error:init.error,complete:function(){$.cookie("com.sivvit.event",JSON.stringify({action:"update",model:self.formatModel()}))}})},formatModel:function(){var result={startDate:Date.dateToSeconds(this.get("startDate")),endDate:Date.dateToSeconds(this.get("endDate")),location:this.get("location"),title:this.get("title"),description:this.get("description"),keywords:this.get("keywords"),id:this.get("id")};return result},appendHistogram:function(hash,value){var len=
value.length;var result=[];for(var i=len;i--;)if(hash[value[i].timestamp])hash[value[i].timestamp].count=Number(hash[value[i].timestamp].count)+Number(value[i].count);else hash[value[i].timestamp]=value[i];for(var bucket in hash)if(hash[bucket])result.push(hash[bucket]);return result},updateContentRange:function(date){if(this.attributes.content_bounds.min===null){this.attributes.content_bounds.min=this.get("endDate");this.attributes.content_bounds.max=this.get("startDate")}this.attributes.content_bounds.min=
Math.min(date,this.attributes.content_bounds.min);this.attributes.content_bounds.max=Math.max(date,this.attributes.content_bounds.max)},setSinceRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta="+this.attributes.meta;if(this.attributes.limit!==null)path+="&limit="+this.attributes.limit;if(this.attributes.last_update!==null)path+="&since="+this.attributes.last_update;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+this.attributes.bucket_limit;
if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==null)path+="&resolution="+this.attributes.histogram.resolution;this.url=path},setRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta=0";if(this.attributes.limit!==null)path+="&limit="+this.attributes.limit;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+
this.attributes.bucket_limit;if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==null)path+="&resolution="+this.attributes.histogram.resolution;this.url=path},setRequestType:function(type){switch(type){case "all":this.attributes.type="photo&type[]=media&type[]=post";break;case "media":this.attributes.type="media&type[]=photo";break;case "photo":this.attributes.type=
"photo";break;case "post":this.attributes.type="post";break}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1;this.setRequestURL();this.fetch()},startLiveData:function(){var self=this;this.stopLiveData();this.fetch_interval=setInterval(function(){self.fetch()},1E4)},stopLiveData:function(){clearInterval(this.fetch_interval)}});SIVVIT.HistogramView=Backbone.View.extend({bars:[],slider:false,initialize:function(options){this.model=options.model;this.model.bind("change:histogram",this.render,this)},render:function(){this.drawHistogram();this.updateTime()},updateTime:function(){$("#timeline-mintime").html(this.model.get("startRange").format());$("#timeline-maxtime").html(this.model.get("endRange").format())},drawHistogram:function(){if(this.model.get("histogram")){var adjusted_end_date=this.model.adjustToNextBucket(new Date(this.model.get("histogramEndDate"))).getTime();
var len_total=Math.ceil((adjusted_end_date-this.model.get("histogramStartDate"))/this.model.getResolution());var len=this.model.get("histogram").length;var max_val=this.model.get("max");var max_height=$(this.el).height();var max_width=$(this.el).width();var bar_w=$(this.el).width()/len_total;bar_w=bar_w<0.5?0.5:bar_w;var start_time=this.model.get("histogramStartDate");var end_time=adjusted_end_date;var histogram=Raphael($(this.el)[0],$(this.el).width(),$(this.el).height());for(var i=len;i--;){var frame=
new SIVVIT.TemporalFrameModel(this.model.get("histogram")[i]);var percent_y=frame.get("count")/max_val*100;var percent_x=(frame.get("timestamp").getTime()-start_time)/(end_time-start_time);var bar_h=Math.round(percent_y*max_height/100);var bar_x=Math.round(percent_x*max_width);var bar_y=Math.round(max_height-bar_h);var bar=histogram.rect(bar_x,bar_y,bar_w,bar_h).attr({fill:"#333333","stroke-width":0})}}}});