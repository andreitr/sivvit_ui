(function(){$("#new-event").fancybox({"width":860,"height":430,"autoScale":true,"scrolling":false,"transitionIn":"fade","transitionOut":"fade","type":"iframe"})})();if(typeof SIVVIT=="undefined")SIVVIT={};
(function(jQuery,SIVVIT){SIVVIT.Events={collection:null,view:null,edit:true,init:function(json){var self=this;this.collection=new SIVVIT.EventsCollection;this.view=new SIVVIT.EventsView({edit:this.edit});$.getJSON(json,function(data){$("#content-loader").remove();$("#event-application").show();var len=data.length,i;for(i=len;i--;){var model=new SIVVIT.EventModel(data[i]);model.set({timestamp:new Date(data[i])});self.collection.add(model)}self.view.model=self.collection;self.view.render()})}};SIVVIT.EventsCollection=
Backbone.Collection.extend({model:SIVVIT.EventModel,comparator:function(itm){return itm.get("startDate")}});SIVVIT.EventsView=Backbone.View.extend({template:"<li id='post-list'><div id='content'><div id='histogram'></div><div id='title'>${title}</div>${description}<div id='meta'>${posts} posts, ${images} images, ${videos} videos &nbsp; &nbsp;<span class='icon-location'></span>${location} &nbsp;<span class='icon-user'></span><a href='#'>${author}</a></div></div></div></li>",el:"#dynamic-content",rendered:[],
edit:false,displayed:false,initialize:function(options){this.edit=options.edit},render:function(){$(this.el).empty();this.displayed=false;this.rendered=[];if(this.edit)this.displayEdit();this.display()},display:function(){$(this.el).append("<ol id='event-list'></ol>");this.model.each(function(itm){itm=this.buildTemplate(itm);var histogram=(new SIVVIT.HistogramView({el:$(itm.html).find("#histogram"),slider:false,model:new SIVVIT.TemporalModel({startDate:new Date(itm.model.get("startDate")),endDate:new Date(itm.model.get("last_update")),
min:itm.model.get("histogram").min,max:itm.model.get("histogram").max,resolution:itm.model.get("histogram").resolution,histogram:itm.model.get("histogram").global})})).render();this.initItem(itm,"#event-list")},this)},buildTemplate:function(itm){var html=$.tmpl(this.template,{title:itm.get("title"),description:itm.get("description"),posts:itm.get("stats").posts,videos:itm.get("stats").videos,images:itm.get("stats").images,location:itm.get("location").name,author:itm.get("author")});return{html:html,
model:itm}},displayEdit:function(){$(this.el).append('<div id="controls-container"><div id="checkbox"><input type="checkbox" id="group-select"></div><a id="del-all" class="link"><span class="icon-delete"></span>Delete</a><a id="pause-all" class="link"></div>');var self=this;$("#del-all").click(function(){var i=self.rendered.length;var result=[];while(i--){var itm=self.rendered[i];if(itm.html.find("#itm-check").is(":checked"))result.push(itm)}if(result.length>0)if(confirm("Delete "+result.length+" events?")===
true)self.deleteItems(result)});$("group-select").click(function(){var i=self.rendered.length;var checked=$("#group-select").is(":checked");while(i--){var itm=self.rendered[i];itm.html.find("#itm-check").attr("checked",checked);itm.html.css("background-color",!checked?"#FFFFFF":"#FFFFCC")}})},initItem:function(itm,parent){var self=this;if(itm!==null){if(this.edit){itm.html.find("#content").prepend('<span class="item-edit"><span class="icon-delete" id="del-itm"></span><span class=\'icon-cog\' href="event_form.html?id='+
itm.model.get("id")+'" id=\'edit-itm\'></span><div id="pending-flag"></div></span>');itm.html.find("#content").prepend('<div id="checkbox"><input type="checkbox" id="itm-check"/></div>');itm.html.find("#del-itm").hide();itm.html.find("#edit-itm").hide();itm.html.find("#edit-itm").fancybox({"width":860,"height":430,"autoScale":true,"scrolling":false,"transitionIn":"fade","transitionOut":"fade","type":"iframe"});if(itm.model.get("pending")>0)itm.html.find("#title").append("<div id='pending'>pending "+
itm.model.get("pending")+"</div>");itm.html.hover(function(event){itm.html.find("#del-itm").show();itm.html.find("#edit-itm").show()},function(event){itm.html.find("#del-itm").hide();itm.html.find("#edit-itm").hide()});itm.html.click(function(event){var checked;switch(event.target.id){case "del-itm":if(confirm("Delete this event?")===true){self.deleteItem(itm);event.stopPropagation()}break;case "edit-itm":break;default:if(itm.html.find("#itm-check").length>0){checked=itm.html.find("#itm-check").is(":checked");
itm.html.find("#itm-check").attr("checked",!checked);itm.html.css("background-color",checked?"#FFFFFF":"#FFFFCC")}event.stopPropagation()}});this.toggleLive(itm)}this.rendered.push(itm);$(parent).append(itm.html)}},deleteItem:function(itm){itm.html.fadeOut();this.model.remove(itm.model,{silent:true})},deleteItems:function(itms){for(var i=itms.length;i--;)this.deleteItem(itms[i])},toggleLive:function(itm){var flag=itm.html.find("#pending-flag");if(itm.model.get("status")===1){flag.toggleClass("idle-notice",
false);flag.toggleClass("live-notice",true)}else{flag.toggleClass("idle-notice",true);flag.toggleClass("live-notice",false)}}})})($,SIVVIT);SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:new Date,endDate:new Date,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},post_hash:{},media_hash:{},global_hash:{},fetch_interval:null,
initialize:function(){this.bind("change",function(){if(this.get("status")<1)this.stopLiveData();else this.startLiveData()},this)},fetch:function(options){this.stopLiveData();Backbone.Model.prototype.fetch.call(this,options)},set:function(attributes,options){if(attributes.hasOwnProperty("histogram")&&attributes.histogram!==undefined&&attributes.histogram!==null){if(this.get("histogram")!==undefined){attributes.histogram.max=Math.max(attributes.histogram.max,this.get("histogram").max);attributes.histogram.min=
Math.min(attributes.histogram.min,this.get("histogram").min)}if(attributes.histogram.post!==undefined)attributes.histogram.post=this.appendHistogram(this.post_hash,attributes.histogram.post);if(attributes.histogram.media!==undefined)attributes.histogram.media=this.appendHistogram(this.media_hash,attributes.histogram.media);if(attributes.histogram.global!==undefined)attributes.histogram.global=this.appendHistogram(this.global_hash,attributes.histogram.global)}Backbone.Model.prototype.set.call(this,
attributes,options);return this},appendHistogram:function(hash,value){var len=value.length;var result=[];for(var i=len;i--;)if(hash[value[i].timestamp])hash[value[i].timestamp].count=Number(hash[value[i].timestamp].count)+Number(value[i].count);else hash[value[i].timestamp]=value[i];for(var bucket in hash)result.push(hash[bucket]);return result},updateContentRange:function(date){if(this.attributes.content_bounds.min===null){this.attributes.content_bounds.min=new Date(this.get("endDate"));this.attributes.content_bounds.max=
new Date(this.get("startDate"))}this.attributes.content_bounds.min=Math.min(date,this.attributes.content_bounds.min);this.attributes.content_bounds.max=Math.max(date,this.attributes.content_bounds.max)},hasMoreContent:function(){if(this.get("content_bounds").min>new Date(this.get("startDate")))return true;else return false},setSinceRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta="+this.attributes.meta;if(this.attributes.limit!==null)path+="&limit="+
this.attributes.limit;if(this.attributes.last_update!==null)path+="&since="+this.attributes.last_update;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+this.attributes.bucket_limit;if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==null)path+="&resolution="+this.attributes.histogram.resolution;else path+="&resolution=hour";this.url=path},
setRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta=0";if(this.attributes.limit!==null)path+="&limit="+this.attributes.limit;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+this.attributes.bucket_limit;if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==null)path+="&resolution="+this.attributes.histogram.resolution;
this.url=path},setRequestType:function(type){switch(type){case "all":this.attributes.type="photo&type[]=media&type[]=post";break;case "media":this.attributes.type="media&type[]=photo";break;case "photo":this.attributes.type="photo";break;case "post":this.attributes.type="post";break}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1;this.setRequestURL();this.fetch()},startLiveData:function(){var self=this;this.stopLiveData();this.fetch_interval=setInterval(function(){self.fetch()},
1E4)},stopLiveData:function(){clearInterval(this.fetch_interval)}});SIVVIT.TemporalModel=Backbone.Model.extend({defaults:{startDate:new Date,endDate:new Date,startRange:null,endRange:null,min:null,max:null,histogram:null,histogramStartDate:null,histogramEndDate:null,resolution:null,type:null},set:function(attributes,options){if(attributes.hasOwnProperty("histogram")&&attributes.histogram!==undefined&&attributes.histogram!==null){this.bucket_hash={};this.set({histogramStartDate:null});this.set({histogramEndDate:null});var len=attributes.histogram.length;for(var i=
len;i--;){attributes.histogram[i].timestamp=new Date(attributes.histogram[i].timestamp);if(this.checkDateBounds(attributes.histogram[i].timestamp)===true){this.bucket_hash[attributes.histogram[i].timestamp]=attributes.histogram[i];if(!this.get("histogramStartDate")||!this.get("histogramEndDate")){this.set({histogramStartDate:attributes.histogram[i].timestamp});this.set({histogramEndDate:attributes.histogram[i].timestamp})}else{this.set({histogramStartDate:Math.min(attributes.histogram[i].timestamp,
this.get("histogramStartDate"))});this.set({histogramEndDate:Math.max(attributes.histogram[i].timestamp,this.get("histogramEndDate"))})}}else attributes.histogram.splice(i,1)}}Backbone.Model.prototype.set.call(this,attributes,options);return this},adjustResolution:function(date){switch(this.get("resolution")){case "day":return new Date(date.getFullYear(),date.getMonth(),date.getDate());case "hour":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours());case "minute":return new Date(date.getFullYear(),
date.getMonth(),date.getDate(),date.getHours(),date.getMinutes());case "second":return new Date(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds())}},adjustToNextBucket:function(date,resolution){var new_date;resolution=resolution===undefined?this.get("resolution"):resolution;switch(resolution){case "day":new_date=this.adjustResolution(date);new_date.setDate(new_date.getDate()+1);return new_date;case "hour":new_date=this.adjustResolution(date);new_date.setHours(new_date.getHours()+
1);return new_date;case "minute":new_date=this.adjustResolution(date);new_date.setMinutes(new_date.getMinutes()+1);return new_date;case "second":new_date=this.adjustResolution(date);new_date.setSeconds(new_date.getSeconds()+1);return new_date}},getResolution:function(){switch(this.get("resolution")){case "day":return 864E5;case "hour":return 36E5;case "minute":return 6E4;case "second":return 1E3}},checkDateBounds:function(date){return date>=this.get("startDate")&&date<=this.get("endDate")?true:false}});SIVVIT.HistogramView=Backbone.View.extend({bars:[],slider:false,initialize:function(options){this.slider=options.slider;this.model=options.model;this.model.bind("change:histogram",this.render,this)},render:function(){this.drawHistogram();if(this.slider)this.drawSlider()},drawSlider:function(){var self=this;$("#timeline-slider").slider({range:true,min:this.model.get("histogramStartDate"),max:this.model.get("histogramEndDate"),values:[this.model.get("startRange").getTime(),this.model.get("endRange").getTime()],
stop:function(event,ui){self.onSliderDragged(event,ui)}});this.updateTime()},onSliderDragged:function(event,ui){this.model.set({"startRange":new Date(ui.values[0])});this.model.set({"endRange":new Date(ui.values[1])});this.updateBars()},updateBars:function(){for(var i=this.bars.length;i--;)this.updateBarColor(this.bars[i]);this.updateTime()},updateTime:function(){$("#timeline-mintime").html(this.model.get("startRange").format());$("#timeline-maxtime").html(this.model.get("endRange").format())},updateBarColor:function(bar){if((new Date(bar.timestamp)).getTime()>=
this.model.get("startRange").getTime()&&(new Date(bar.timestamp)).getTime()<=this.model.get("endRange").getTime())bar.attr({fill:"#333333"});else bar.attr({fill:"#CCCCCC"})},drawHistogram:function(){if(this.model.get("histogram")){var adjusted_end_date=this.model.adjustToNextBucket(new Date(this.model.get("histogramEndDate"))).getTime();var lenTotal=Math.ceil((adjusted_end_date-this.model.get("histogramStartDate"))/this.model.getResolution());var len=this.model.get("histogram").length;var maxVal=
this.model.get("max");var minVal=this.model.get("min");var maxHeight=$(this.el).height();var maxWidth=$(this.el).width();var barW=$(this.el).width()/lenTotal;barW=barW<0.5?0.5:barW;var startTime=this.model.get("histogramStartDate");var endTime=adjusted_end_date;var histogram=Raphael($(this.el)[0],$(this.el).width(),$(this.el).height());for(var i=len;i--;){var frame=this.model.get("histogram")[i];var percentY=frame.count/maxVal*100;var percentX=(frame.timestamp.getTime()-startTime)/(endTime-startTime);
var barH=Math.round(percentY*maxHeight/100);var barX=Math.round(percentX*maxWidth);var barY=Math.round(maxHeight-barH);var bar=histogram.rect(barX,barY,barW,barH).attr({fill:"#333333","stroke-width":0});if(this.slider){bar.timestamp=frame.timestamp;this.updateBarColor(bar);this.bars.push(bar)}}}}});