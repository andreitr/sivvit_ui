typeof SIVVIT=="undefined"&&(SIVVIT={}),SIVVIT.Settings={host:"http://sivvit.com"},function(a,b){b.EditEvent={model:null,view:null,init:function(a){var c=this;a===null||a===undefined?this.model=new b.EventModel({startDate:Date.dateToSeconds(new Date),endDate:Date.dateToSeconds(new Date((new Date).getTime()+864e5)),pull:!1,meta:0,type:null}):this.model=new b.EventModel({json:b.Settings.host+"/event/"+a+".json?callback=?",pull:!1,meta:0,type:null}),this.view=new b.EditEventView({model:this.model}),a===null||a===undefined?(this.view.update(),this.setLocation(),this.view.initMap()):(this.model.setRequestURL(),this.model.fetch())},setLocation:function(){this.setDefaultLocation();var a=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(b){a.model.set({location:{lon:b.coords.latitude,lat:b.coords.longitude}},{silent:!0})})},setDefaultLocation:function(){this.model.set({location:{name:"Denver, CO",lat:39.739167,lon:-104.984722}},{silent:!0})}},b.EditEventView=Backbone.View.extend({el:"#form-container",map:null,map_complete:null,events:{"click #save-event-btn":"saveEvent","click #delete-event-btn":"deleteEvent"},initialize:function(a){this.model=a.model,this.model.bind("change",this.update,this),this.model.bind("change:location",this.initMap,this),this.setValidationRules()},deleteEvent:function(){var a=this,b={complete:function(b,c){c==="error"?this.error():(a.showHideSavingState(),window.parent.$.fancybox.close([!0]))},error:function(){a.showHideSavingState("Error deleting event..., please try again."),setTimeout(function(){a.showHideSavingState()},3e3)}};this.showHideSavingState("Hold it cowboy, working on it..."),this.model.deleteEvent(b)},saveEvent:function(){if($("#form-main").valid()){var a=this,b={success:function(){a.showHideSavingState()},error:function(){a.showHideSavingState("Error saving event..., please try again."),setTimeout(function(){a.showHideSavingState()},3e3)}};this.showHideSavingState("Hold it cowboy, working on it..."),this.model.get("id")?this.model.updateEvent(b):this.model.createEvent(b)}},showHideSavingState:function(a){var b=$(this.el).find("#save-msg");b.length>0&&b.remove(),a?($(this.el).find("#save-event-btn").hide(),$(this.el).find("#delete-event-btn").hide(),$(this.el).find("#button-container").append("<span id='save-msg'>"+a+"<span class='loader'></span></span>")):($(this.el).find("#save-event-btn").show(),$(this.el).find("#delete-event-btn").show())},update:function(){var a=this;$("#form-container").show(),$("#content-loader").hide(),this.model.get("id")||($(this.el).find("#delete-event-btn").hide(),$(this.el).find("#save-event-btn").text("Create New Event")),$("input[name='title']").val(this.model.get("title")),$("input[name='title']").change(function(){a.model.set({title:$(this).val()},{silent:!0})}),$("input[name='location']").val(this.model.get("location").name),$("input[name='keywords']").val(this.model.get("keywords")),$("input[name='keywords']").change(function(){a.model.set({keywords:$(this).val().split(",")},{silent:!0})}),$("input[name='description']").val(this.model.get("description")),$("input[name='description']").change(function(){a.model.set({description:$(this).val()},{silent:!0})}),$("input[name='start-date']").val(this.model.get("startDate").format()),$("input[name='start-date']").datetimepicker({dateFormat:"mm/dd/yy",defaultDate:this.model.get("startDate"),hour:this.model.get("startDate").getHours(),minute:this.model.get("startDate").getMinutes(),second:this.model.get("startDate").getSeconds(),onSelect:function(b){a.model.set({startDate:Date.dateToSeconds(new Date(b))},{silent:!0})}}),$("input[name='end-date']").val(this.model.get("endDate").format()),$("input[name='end-date']").datetimepicker({dateFormat:"mm/dd/yy",defaultDate:this.model.get("endDate"),hour:this.model.get("endDate").getHours(),minute:this.model.get("endDate").getMinutes(),second:this.model.get("endDate").getSeconds(),onSelect:function(b){a.model.set({endDate:Date.dateToSeconds(new Date(b))},{silent:!0})}}),$("#form-main").validate().element("input[name='title']"),$("#form-main").validate().element("input[name='keywords']"),$("#form-main").validate().element("input[name='start-date']"),$("#form-main").validate().element("input[name='end-date']")},setValidationRules:function(){var a=this;$("#form-main").validate({success:function(a){},errorPlacement:function(a,b){},highlight:function(b,c){var d=$(a.el).find("#"+$(b).attr("name")+"-check");d.toggleClass("icon-check-red",!0),d.toggleClass("icon-check-green",!1),$(b).css("background-color","#FFFFCC")},unhighlight:function(b,c){var d=$(a.el).find("#"+$(b).attr("name")+"-check");d.toggleClass("icon-check-red",!1),d.toggleClass("icon-check-green",!0),$(b).css("background-color","#FFFFFF")},rules:{title:{required:!0,minlength:3},keywords:{required:!0,minlength:3},"start-date":{required:!0,date:!0},"end-date":{required:!0,date:!0}}})},initMap:function(){var a=this;this.map?this.map.setCenter(new google.maps.LatLng(a.model.get("location").lon,a.model.get("location").lat)):(this.map=new google.maps.Map($("#form-map")[0],{center:new google.maps.LatLng(a.model.get("location").lat,a.model.get("location").lon),zoom:8,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP}),this.map_complete=new google.maps.places.Autocomplete($("input[name='location']")[0]),google.maps.event.addListener(this.map_complete,"place_changed",function(){var b=a.map_complete.getPlace();a.map.setCenter(b.geometry.location),a.model.set({location:{lat:b.geometry.location.lat(),lon:b.geometry.location.lng(),name:b.name}},{silent:!0})}))}})}($,SIVVIT),Date.prototype.format=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+String(this.getFullYear()).substr(2,2)+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()},Date.secondsToDate=function(a){return new Date(a*1e3)},Date.dateToSeconds=function(a){return Math.round(a.getTime()/1e3)},Date.plusSecond=function(a){return a.getSeconds()===59?Date.plusMinute(new Date(a.setSeconds(0))):new Date(a.setSeconds(a.getSeconds()+1))},Date.plusMinute=function(a){return a.getMinutes()===59?Date.plusHour(new Date(a.setMinutes(0))):new Date(a.setMinutes(a.getMinutes()+1))},Date.plusHour=function(a){return a.getHours()===23?Date.plusDay(new Date(a.setHours(0))):new Date(a.setHours(a.getHours()+1))},Date.plusDay=function(a){return a.getDate()===Date.daysInMonth(a.getMonth(),a.getFullYear())?Date.plusMonth(new Date(a.setDate(1))):new Date(a.setDate(a.getDate()+1))},Date.plusMonth=function(a){return a.getMonth()===11?Date.plusYear(new Date(a.setMonth(0))):new Date(a.setMonth(a.getMonth()+1))},Date.plusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()+1)))},Date.minusSecond=function(a){return a.getSeconds()===0?Date.minusMinute(new Date(a.setSeconds(59))):new Date(a.setSeconds(a.getSeconds()-1))},Date.minusMinute=function(a){return a.getMinutes()===0?Date.minusHour(new Date(a.setMinutes(59))):new Date(a.setMinutes(a.getMinutes()-1))},Date.minusHour=function(a){return a.getHours()===0?Date.minusDay(new Date(a.setHours(23))):new Date(a.setHours(a.getHours()-1))},Date.minusDay=function(a){return a.getDate()===1?Date.minusMonth(new Date(a.setDate(Date.daysInMonth(a.getMonth(),a.getFullYear())))):new Date(a.setDate(a.getDate()-1))},Date.minusMonth=function(a){return a.getMonth()===0?Date.minusYear(new Date(a.setMonth(11))):new Date(a.setMonth(a.getMonth()-1))},Date.minusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()-1)))},Date.daysInMonth=function(a,b){return 32-(new Date(b,a,32)).getDate()},SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,pull:!0,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:null,endDate:null,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},fetch_interval:null,parse:function(a,b){return this.get("status")!==1&&this.get("status")!==0||this.get("pull")!==!0?this.stopLiveData():this.startLiveData(),a},fetch:function(a){this.stopLiveData(),Backbone.Model.prototype.fetch.call(this,a)},set:function(a,b){return a.hasOwnProperty("status")&&a.status!==undefined&&a.status!==null&&(a.status=Number(a.status)),a.hasOwnProperty("startDate")&&(a.startDate=Date.secondsToDate(a.startDate)),a.hasOwnProperty("endDate")&&(a.endDate=Date.secondsToDate(a.endDate)),a.hasOwnProperty("last_update")&&(a.last_update=Date.secondsToDate(a.last_update)),a.hasOwnProperty("histogram")&&a.histogram!==undefined&&a.histogram!==null&&(this.attributes.post_hash=this.attributes.post_hash||{},this.attributes.media_hash=this.attributes.media_hash||{},this.attributes.global_hash=this.attributes.global_hash||{},this.get("histogram")!==undefined&&(a.histogram.max=Math.max(a.histogram.max,this.get("histogram").max),a.histogram.min=Math.min(a.histogram.min,this.get("histogram").min)),a.histogram.post!==undefined&&a.histogram.post!==null?a.histogram.post=this.appendHistogram(this.get("post_hash"),a.histogram.post):a.histogram.post=this.get("histogram")?this.get("histogram").post:null,a.histogram.media!==undefined&&a.histogram.media!==null?a.histogram.media=this.appendHistogram(this.get("media_hash"),a.histogram.media):a.histogram.media=this.get("histogram")?this.get("histogram").media:null,a.histogram.global!==undefined&&a.histogram.global!==null?a.histogram.global=this.appendHistogram(this.get("global_hash"),a.histogram.global):a.histogram.global=this.get("histogram")?this.get("histogram").global:null),Backbone.Model.prototype.set.call(this,a,b),this},createEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/",data:b.formatModel(),type:"POST",dataType:"json",success:a.success,complete:function(a,b){b!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"create",model:JSON.parse(a.responseText)}))},error:a.error})},deleteEvent:function(a){var b=this;a=a||{success:null,complete:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"DELETE",dataType:"json",complete:function(c,d){d!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"delete",model:b.formatModel()})),a.complete(c,d)},error:a.error})},updateEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"PUT",dataType:"json",success:a.success,error:a.error,complete:function(a,c){c!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"update",model:b.formatModel()}))}})},formatModel:function(){var a={startDate:Date.dateToSeconds(this.get("startDate")),endDate:Date.dateToSeconds(this.get("endDate")),location:this.get("location"),title:this.get("title"),description:this.get("description"),keywords:this.get("keywords"),id:this.get("id")};return a},appendHistogram:function(a,b){var c,d=b.length,e=[];for(c=d;c--;)a[b[c].timestamp]?a[b[c].timestamp].count=Number(a[b[c].timestamp].count)+Number(b[c].count):a[b[c].timestamp]=b[c];for(var f in a)a[f]&&e.push(a[f]);return e},updateContentRange:function(a){this.attributes.content_bounds.min===null&&(this.attributes.content_bounds.min=this.get("endDate"),this.attributes.content_bounds.max=this.get("startDate")),this.attributes.content_bounds.min=Math.min(a,this.attributes.content_bounds.min),this.attributes.content_bounds.max=Math.max(a,this.attributes.content_bounds.max)},setSinceRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta="+this.attributes.meta),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.last_update!==null&&(a+="&since="+this.attributes.last_update),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta=0"),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestType:function(a){switch(a){case"all":this.attributes.type="photo&type[]=media&type[]=post";break;case"media":this.attributes.type="media&type[]=photo";break;case"photo":this.attributes.type="photo";break;case"post":this.attributes.type="post"}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1,this.setRequestURL(),this.fetch()},resetContent:function(){this.set({bucket_page:1,content:null},{silent:!0})},startLiveData:function(){var a=this;this.stopLiveData(),this.fetch_interval=setInterval(function(){a.fetch()},1e4)},stopLiveData:function(){clearInterval(this.fetch_interval)}});