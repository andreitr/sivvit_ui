typeof SIVVIT=="undefined"&&(SIVVIT={}),SIVVIT.Settings={host:"http://sivvit.com"},function(a,b){b.Event={eventModel:null,temporalModel:null,contentController:null,contentView:null,headerView:null,mapView:null,sideHistView:null,edit:!0,init:function(a){var c=this;b.Lightbox.init(),this.temporalModel=new b.TemporalModel,this.eventModel=new b.EventModel,this.headerView=new b.HeaderView({model:this.eventModel}),this.mapView=new b.MapView({el:"#js-e-map"}),this.sideHistView=new b.HistogramView({el:"#js-e-timeline",model:this.temporalModel}),this.contentView=new b.ContentView({edit:this.edit,temporalModel:this.temporalModel,eventModel:this.eventModel}),this.contentController=new b.ContentController({eventModel:this.eventModel,temporalModel:this.temporalModel,view:this.contentView}),this.eventModel.set({json:b.Settings.host+"/event/"+a+".json?callback=?"}),this.eventModel.setSinceRequestURL(),this.eventModel.fetch(),this.eventModel.bind("change",function(){$("#js-app-loader").remove(),$("#js-app").show(),(c.eventModel.hasChanged("title")||c.eventModel.hasChanged("description")||c.eventModel.hasChanged("location"))&&c.headerView.render(),c.eventModel.hasChanged("last_update")&&(c.headerView.reset(c.eventModel.get("last_update")),c.eventModel.setSinceRequestURL());if(c.eventModel.hasChanged("last_update")||c.eventModel.hasChanged("histogram"))c.temporalModel.set({startDate:c.eventModel.get("startDate"),endDate:c.eventModel.get("last_update"),startRange:c.eventModel.get("startDate"),endRange:c.eventModel.get("last_update"),min:Math.min(c.temporalModel.get("min"),c.eventModel.get("histogram").min),max:Math.max(c.temporalModel.get("max"),c.eventModel.get("histogram").max),resolution:c.eventModel.get("histogram").resolution},{silent:!0}),c.contentController.update();c.eventModel.hasChanged("location")&&c.mapView.render(c.eventModel.get("location").name,c.eventModel.get("location").lat,c.eventModel.get("location").lon)})}},b.ItemGroupCollection=Backbone.Collection.extend({model:b.ItemGroupModel,comparator:function(a){return-a.get("timestamp")}}),b.ItemCollection=Backbone.Collection.extend({model:b.ItemModel,comparator:function(a){return-a.get("timestamp")}}),b.NewItemCollection=Backbone.Collection.extend({model:b.ItemModel,comparator:function(a){return a.get("timestamp")}}),b.Lightbox={init:function(){$("#photo-box").fancybox({maxWidth:800,maxHeight:600,fitToView:!0,autoSize:!0,width:"70%",height:"70%",closeClick:!1,transitionIn:"fade",transitionOut:"fade"}),$.waypoints.settings.scrollThrottle=30,$("#wrapper").waypoint.defaults.onlyOnScroll=!0,$("#wrapper").waypoint({offset:"-100%"}).find("#js-mover-trigger").waypoint(function(a,b){$("#js-mover").toggleClass("sticky",b==="down"),a.stopPropagation()})}},b.Parser={parse:function(a){var c=a.get("content"),d,e,f=[],g,h,i,j=c.length;for(d=0;d<j;d+=1){h=new b.ItemGroupModel(c[d]),h.set({json:a.get("json")}),g=[];for(e=0;e<c[d].items.length;e+=1)i=new b.ItemModel(c[d].items[e]),i.set({timestamp:c[d].items[e].timestamp}),g.push(i);h.set({id:(new Date).getTime()+"-"+d,items:new b.ItemCollection(g),items_new:new b.ItemCollection(g),stats:c[d].stats,timestamp:c[d].timestamp}),a.updateContentRange(h.get("timestamp")),f.push(h)}return new b.ItemGroupCollection(f)}},b.ContentController=Backbone.View.extend({el:"#navigation-content",prevButton:null,activeButton:null,view:null,eventModel:null,temporalModel:null,events:{"click #js-all-btn":"updateView","click #js-post-btn":"updateView","click #js-media-btn":"updateView"},initialize:function(a){this.eventModel=a.eventModel,this.temporalModel=a.temporalModel,this.view=a.view,this.activeButton="#js-all-btn",$(this.activeButton).toggleClass("text-btn",!1),$(this.activeButton).toggleClass("text-btn-selected",!0)},update:function(){this.renderStats(),this.renderHistogram()},updateView:function(a){if(this.renderButtons(a.target.id)){this.enableNavigation(!1),this.update(),this.view.reset(),this.eventModel.resetContent();switch(a.target.id){case"js-all-btn":this.eventModel.setRequestType("all");break;case"js-post-btn":this.eventModel.setRequestType("post");break;case"js-media-btn":this.eventModel.setRequestType("media")}this.eventModel.on("change",this.resetEvents,this),this.eventModel.setRequestURL(),this.eventModel.fetch()}},resetEvents:function(){this.enableNavigation(!0),this.eventModel.off("change",this.resetEvents,this)},enableNavigation:function(a){a?this.delegateEvents(this.events):this.undelegateEvents()},renderStats:function(){var a=$("#js-e-stats");switch(this.activeButton){case"#js-all-btn":a.html("Total: "+this.eventModel.get("stats").total);break;case"#js-post-btn":a.html("Posts: "+this.eventModel.get("stats").posts);break;case"#js-media-btn":a.html("Media: "+(this.eventModel.get("stats").images+this.eventModel.get("stats").videos))}},renderButtons:function(a){return this.activeButton==="#"+a?!1:(this.prevButton=this.activeButton,this.activeButton="#"+a,$(this.activeButton).toggleClass("text-btn",!1),$(this.activeButton).toggleClass("text-btn-selected",!0),this.prevButton!==this.activeButton&&($(this.prevButton).toggleClass("text-btn",!0),$(this.prevButton).toggleClass("text-btn-selected",!1)),!0)},renderHistogram:function(){switch(this.activeButton){case"#js-all-btn":this.temporalModel.set({histogram:this.eventModel.get("histogram").global});break;case"#js-post-btn":this.temporalModel.set({histogram:this.eventModel.get("histogram").post});break;case"#js-media-btn":this.temporalModel.set({histogram:this.eventModel.get("histogram").media})}}}),b.ContentView=Backbone.View.extend({el:"#js-app-content",post_template:$("#tpl_content-post").html(),photo_template:$("#tpl_content-photo").html(),media_template:$("#tpl_content-media").html(),rendered:[],groups:[],groups_key:{},new_count:0,new_groups:new b.NewItemCollection,temporalModel:null,eventModel:null,edit:!1,displayed:!1,display_buckets:!1,initialize:function(a){this.edit=a.edit,this.temporalModel=a.temporalModel,this.eventModel=a.eventModel,this.eventModel.on("change",this.onModelContentUpdate,this)},onModelContentUpdate:function(a){if(this.eventModel.hasChanged("content")||this.rendered.length===0){var c=b.Parser.parse(this.eventModel);if(this.rendered.length<=0){this.model=c,this.render();return}if(this.display_buckets){this.display_buckets=!1,this.display(c,!1),this.footer();return}c.each(function(a){var b=this.groups_key[a.get("timestamp")],c;b?(c=b.get("stats"),c.total=Number(c.total)+Number(a.get("stats").total),c.media=Number(c.media)+Number(a.get("stats").media),c.post=Number(c.post)+Number(a.get("stats").post),this.buildGroupHeader(b),this.buildGroupFooter(b)):(this.groups_key[a.get("timestamp")]=a,this.new_count+=1,this.new_groups.add(a))},this),this.new_count>0&&this.update()}},update:function(){var a=this;$("#load-content-btn").length<=0&&($(this.el).prepend($("#tpl_more-content").html()),$("#load-content-btn").hide(),$("#load-content-btn").slideDown("slow"),$("#load-content-btn").click(function(b){$(b.currentTarget).remove(),a.display(a.new_groups,!0),a.new_count=0,a.new_groups.reset(),a.updateEdit()}))},reset:function(){this.groups_key={},this.groups=[],this.rendered=[],this.showLoader()},display:function(a,b){var c;a===undefined&&(a=this.model),a.each(function(a){a=this.buildGroup(a,b),this.buildGroupItems(a,!1),this.buildGroupHeader(a),this.buildGroupFooter(a),this.displayed=!0},this)},render:function(){$(this.el).empty(),this.displayed=!1,this.rendered=[],this.groups=[],this.groups_key={},this.displayEdit(),this.display(),this.footer(),this.checkDisplayed()},footer:function(){var a=this,b,c;b=$(this.el).find("#load-groups-btn"),b.length>0&&b.remove(),c=this.temporalModel.adjustToNextBucket(new Date(this.eventModel.get("content_bounds").min)),this.eventModel.get("content").length>0&&c>this.temporalModel.adjustToNextBucket(this.eventModel.get("startDate"))&&$("#load-groups-btn").length<=0&&($(this.el).append("<div id='load-groups-btn' class='content-loader loader-margin'>More "+this.eventModel.get("histogram").resolution+"s<span class='icon-download'></span></div>"),b=$(this.el).find("#load-groups-btn"),b.click(function(){b.waypoint("remove"),b.html("<span class='loader'>&nbsp;</span>"),a.display_buckets=!0,a.eventModel.loadMoreContent()}),b.waypoint(function(c,d){c.stopPropagation(),b.waypoint("remove"),b.html("<span class='loader'>&nbsp;</span>"),a.display_buckets=!0,a.eventModel.loadMoreContent()},{offset:"100%",onlyOnScroll:!0}))},showLoader:function(a){$(this.el).empty(),$(this.el).html("<span class='loader'></span>")},buildTemplate:function(a){var b;switch(a.get("type")){case"photo":b=$.tmpl(this.photo_template,{thumbnail:a.get("thumbnail"),media:a.get("media"),avatar:a.get("avatar"),timestamp:Date.secondsToDate(a.get("timestamp")).format(),author:a.get("author"),source:a.get("source")});break;case"media":b=$.tmpl(this.media_template,{thumbnail:a.get("thumbnail"),media:a.get("media"),avatar:a.get("avatar"),timestamp:Date.secondsToDate(a.get("timestamp")).format(),author:a.get("author"),source:a.get("source")});break;case"post":b=$.tmpl(this.post_template,{content:a.get("content"),avatar:a.get("avatar"),timestamp:Date.secondsToDate(a.get("timestamp")).format(),author:a.get("author"),source:a.get("source")})}return{timestamp:a.get("timestamp"),html:b,model:a}},buildGroup:function(a,b){var c,d;return c="group-"+a.get("id"),d="<ol id='"+c+"'></ol>",b?$(this.el).prepend(d):$(this.el).append(d),a.set({div_id:"#"+c},{silent:!0}),a.bind("change",this.updateGroup,this),this.groups.push(a),this.groups_key[a.get("timestamp")]=a,a},buildGroupHeader:function(a){var b,c;b=this.getItemCount(a),c=$(a.get("div_id")).find("#group-header"),c.length>0&&c.remove(),$(a.get("div_id")).prepend("<div id='group-header'>"+b+" items this "+this.eventModel.get("histogram").resolution+" - "+a.get("timestamp").format())},buildGroupFooter:function(a){var b=this,c,d;d=$(a.get("div_id")).find("#group-footer"),d.length>0&&d.remove(),a.get("displayed")<a.get("stats").total&&($(a.get("div_id")).append("<div id='group-footer'><div id='load-group-btn' class='content-loader'>More from this "+this.eventModel.get("histogram").resolution+"&nbsp;&nbsp;<span class='icon-download'></span></div></div>"),$(a.get("div_id")).find("#load-group-btn").click(function(c){$(c.currentTarget).html("<span class='loader'>&nbsp;</span>"),a.setRequestPath(a.get("timestamp"),b.temporalModel.adjustToNextBucket(a.get("timestamp")),b.eventModel.get("limit"),b.eventModel.get("histogram").resolution,b.eventModel.get("type")),a.set({old_items:a.get("items")},{silent:!0}),a.fetch()}))},buildGroupItems:function(a,b){var c=b?a.get("displayed"):0;a.get(b?"items_new":"items").each(function(b){b=this.buildTemplate(b),b&&(this.initItem(b,a),a.set({displayed:c+=1},{silent:!0}))},this)},updateGroup:function(a){var c=[],d,e,f,g,h,i;g=a.get("content"),e=g.length;for(d=0;d<e;d+=1)Date.secondsToDate(g[d].timestamp).getTime()===a.get("timestamp").getTime()&&(f=g[d].items);if(f.length>0){e=a.get("items").length;for(d=0;d<e;d+=1)h=f[d],h&&(i=new b.ItemModel(h),i.set({timestamp:h.timestamp}),c.push(i),a.get("old_items").add(i));a.set({items:a.get("old_items"),items_new:new b.ItemGroupCollection(c)},{silent:!0}),this.buildGroupItems(a,!0),this.buildGroupFooter(a)}},updateEdit:function(){var a=$(this.el).find("#controls-container").remove();a&&$(this.el).prepend(a)},displayEdit:function(){var a=this;this.edit&&($(this.el).append($("#tpl_edit-controls").html()),$("#del-all").click(function(){var b,c;b=a.rendered.length-1;while(b>=0)c=a.rendered[b],c.html.find("#itm-check").is(":checked")&&a.deleteItem(c),b-=1}),$("#apr-all").click(function(){var b,c,d;b=a.rendered.length-1;while(b>=0)c=a.rendered[b],d=c.html.find("#itm-check"),d.is(":checked")&&a.approveItem(c,!0),d.attr("checked",!1),c.html.css("background-color","#FFFFFF"),b-=1;$("#group-select").attr("checked",!1)}),$("#group-select").click(function(){var b,c,d;b=a.rendered.length-1,c=$("#group-select").is(":checked");while(b>=0)d=a.rendered[b],d.html.find("#itm-check").attr("checked",c),d.html.css("background-color",c?"#FFFFCC":"#FFFFFF"),b-=1}))},checkDisplayed:function(){if(!this.displayed){if($("#no-content").length<=0){var a;switch(this.eventModel.get("status")){case 1:a="No content yet but we are working on it...";break;case 2:a="No content found. This collection is archived.";break;case-1:a="No content found. This collection is archived.";break;case 0:a="No content yet, the collection will start shortly."}$(this.el).append("<div id='no-content' class='notification'>"+a+"</div>")}}else $("#no-content").remove()},initItem:function(a,b){a!==null&&(this.edit&&(a.html.find("#content").prepend($("#tpl_edit-item").html()),a.html.find("#del-itm").hide(),a.html.find("#apr-itm").hide(),a.html.find("#load-itm").hide(),this.enableItem(a),this.showHidePending(a)),this.rendered.push(a),$(b.get("div_id")).append(a.html))},enableItem:function(a){var b=this;a.html.find("#load-itm").fadeOut(),a.html.hover(function(b){a.html.find("#del-itm").show(),a.html.find("#apr-itm").show()},function(b){a.html.find("#del-itm").hide(),a.html.find("#apr-itm").hide()}),a.html.click(function(c){var d;switch(c.target.id){case"apr-itm":b.approveItem(a);break;case"del-itm":b.deleteItem(a);break;case"itm-check":d=a.html.find("#itm-check").is(":checked"),a.html.css("background-color",d?"#FFFFCC":"#FFFFFF");break;default:a.html.find("#itm-check").length>0&&(d=a.html.find("#itm-check").is(":checked"),a.html.find("#itm-check").attr("checked",!d),a.html.css("background-color",d?"#FFFFFF":"#FFFFCC"))}})},disableItem:function(a){a.html.unbind(),a.html.find("#del-itm").hide(),a.html.find("#apr-itm").hide(),a.html.find("#load-itm").show()},deleteItem:function(a){this.disableItem(a);var b=this;a.model.set({status:-1}),a.model.save({type:"DELETE",complete:function(c){c.status===200?(a.html.fadeOut(),b.model.remove(a.model,{silent:!0})):(b.enableItem(a),b.showHidePending(a))}})},approveItem:function(a,b){this.disableItem(a);var c=this;b===undefined?b=Number(a.model.get("status"))===1?0:1:b=b===!0?1:0,a.model.set({status:b}),a.model.save({type:"PUT",success:function(){c.enableItem(a),c.showHidePending(a)},error:function(){c.enableItem(a),c.showHidePending(a)}})},showHidePending:function(a){Number(a.model.get("status"))===1?(a.html.find("#pending-flag").toggleClass("pending-notice",!1),a.html.find("#pending-flag").toggleClass("active-notice",!0)):(a.html.find("#pending-flag").toggleClass("pending-notice",!0),a.html.find("#pending-flag").toggleClass("active-notice",!1))},getItemCount:function(a){return a.get("stats").total}}),b.HeaderView=Backbone.View.extend({timestamp:null,render:function(){$("#js-e-title").html(this.model.get("title")),$("#js-e-descr").html("Tracking <strong><i>"+this.model.get("keywords").toString()+"</i></strong> near "+this.model.get("location").name),$("#js-e-user").html("<span class='gray-text'>Created by</span> <span class='icon-user'></span><a href='#'>"+this.model.get("author")+"</a> <span class='gray-text'>on</span> "+this.model.get("startDate").toDateString()),$("#js-e-map-lbl").html("<span class='icon-location'></span>"+this.model.get("location").name),this.update()},reset:function(a){this.timestamp=a,this.update()},update:function(){var a=$("#js-e-timeline-lbl");switch(this.model.get("status")){case 1:a.html("<span class='icon-time'></span>Live, "+this.formatTime(new Date-this.timestamp));break;case 2:a.html("<span class='icon-time'></span>Collection Archived");break;case-1:a.html("<span class='icon-time'></span>Stopping Collection");break;case 0:a.html("<span class='icon-time'></span>Starting Collection")}},formatTime:function(a){var b,c,d,e;return b=Math.floor(a/1e3),c=Math.floor(a/6e4),d=Math.floor(a/36e5),e=Math.floor(a/864e5),e>0?"updated "+e+" days ago":d>0?"updated "+d+" hrs ago":c>0?"updated "+c+" min ago":b>0?"updated "+b+" sec ago":"updated just now"}})}(jQuery,SIVVIT),Date.prototype.format=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+String(this.getFullYear()).substr(2,2)+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()},Date.secondsToDate=function(a){return new Date(a*1e3)},Date.dateToSeconds=function(a){return Math.round(a.getTime()/1e3)},Date.plusSecond=function(a){return a.getSeconds()===59?Date.plusMinute(new Date(a.setSeconds(0))):new Date(a.setSeconds(a.getSeconds()+1))},Date.plusMinute=function(a){return a.getMinutes()===59?Date.plusHour(new Date(a.setMinutes(0))):new Date(a.setMinutes(a.getMinutes()+1))},Date.plusHour=function(a){return a.getHours()===23?Date.plusDay(new Date(a.setHours(0))):new Date(a.setHours(a.getHours()+1))},Date.plusDay=function(a){return a.getDate()===Date.daysInMonth(a.getMonth(),a.getFullYear())?Date.plusMonth(new Date(a.setDate(1))):new Date(a.setDate(a.getDate()+1))},Date.plusMonth=function(a){return a.getMonth()===11?Date.plusYear(new Date(a.setMonth(0))):new Date(a.setMonth(a.getMonth()+1))},Date.plusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()+1)))},Date.minusSecond=function(a){return a.getSeconds()===0?Date.minusMinute(new Date(a.setSeconds(59))):new Date(a.setSeconds(a.getSeconds()-1))},Date.minusMinute=function(a){return a.getMinutes()===0?Date.minusHour(new Date(a.setMinutes(59))):new Date(a.setMinutes(a.getMinutes()-1))},Date.minusHour=function(a){return a.getHours()===0?Date.minusDay(new Date(a.setHours(23))):new Date(a.setHours(a.getHours()-1))},Date.minusDay=function(a){return a.getDate()===1?Date.minusMonth(new Date(a.setDate(Date.daysInMonth(a.getMonth(),a.getFullYear())))):new Date(a.setDate(a.getDate()-1))},Date.minusMonth=function(a){return a.getMonth()===0?Date.minusYear(new Date(a.setMonth(11))):new Date(a.setMonth(a.getMonth()-1))},Date.minusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()-1)))},Date.daysInMonth=function(a,b){return 32-(new Date(b,a,32)).getDate()},SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,pull:!0,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:null,endDate:null,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},fetch_interval:null,parse:function(a,b){return this.get("status")!==1&&this.get("status")!==0||this.get("pull")!==!0?this.stopLiveData():this.startLiveData(),a},fetch:function(a){this.stopLiveData(),Backbone.Model.prototype.fetch.call(this,a)},set:function(a,b){return a.hasOwnProperty("status")&&a.status!==undefined&&a.status!==null&&(a.status=Number(a.status)),a.hasOwnProperty("startDate")&&(a.startDate=Date.secondsToDate(a.startDate)),a.hasOwnProperty("endDate")&&(a.endDate=Date.secondsToDate(a.endDate)),a.hasOwnProperty("last_update")&&(a.last_update=Date.secondsToDate(a.last_update)),a.hasOwnProperty("histogram")&&a.histogram!==undefined&&a.histogram!==null&&(this.attributes.post_hash=this.attributes.post_hash||{},this.attributes.media_hash=this.attributes.media_hash||{},this.attributes.global_hash=this.attributes.global_hash||{},this.get("histogram")!==undefined&&(a.histogram.max=Math.max(a.histogram.max,this.get("histogram").max),a.histogram.min=Math.min(a.histogram.min,this.get("histogram").min)),a.histogram.post!==undefined&&a.histogram.post!==null?a.histogram.post=this.appendHistogram(this.get("post_hash"),a.histogram.post):a.histogram.post=this.get("histogram")?this.get("histogram").post:null,a.histogram.media!==undefined&&a.histogram.media!==null?a.histogram.media=this.appendHistogram(this.get("media_hash"),a.histogram.media):a.histogram.media=this.get("histogram")?this.get("histogram").media:null,a.histogram.global!==undefined&&a.histogram.global!==null?a.histogram.global=this.appendHistogram(this.get("global_hash"),a.histogram.global):a.histogram.global=this.get("histogram")?this.get("histogram").global:null),Backbone.Model.prototype.set.call(this,a,b),this},createEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/",data:b.formatModel(),type:"POST",dataType:"json",success:a.success,complete:function(a,b){b!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"create",model:JSON.parse(a.responseText)}))},error:a.error})},deleteEvent:function(a){var b=this;a=a||{success:null,complete:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"DELETE",dataType:"json",complete:function(c,d){d!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"delete",model:b.formatModel()})),a.complete(c,d)},error:a.error})},updateEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"PUT",dataType:"json",success:a.success,error:a.error,complete:function(a,c){c!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"update",model:b.formatModel()}))}})},formatModel:function(){var a={startDate:Date.dateToSeconds(this.get("startDate")),endDate:Date.dateToSeconds(this.get("endDate")),location:this.get("location"),title:this.get("title"),description:this.get("description"),keywords:this.get("keywords"),id:this.get("id")};return a},appendHistogram:function(a,b){var c,d=b.length,e=[];for(c=d;c--;)a[b[c].timestamp]?a[b[c].timestamp].count=Number(a[b[c].timestamp].count)+Number(b[c].count):a[b[c].timestamp]=b[c];for(var f in a)a[f]&&e.push(a[f]);return e},updateContentRange:function(a){this.attributes.content_bounds.min===null&&(this.attributes.content_bounds.min=this.get("endDate"),this.attributes.content_bounds.max=this.get("startDate")),this.attributes.content_bounds.min=Math.min(a,this.attributes.content_bounds.min),this.attributes.content_bounds.max=Math.max(a,this.attributes.content_bounds.max)},setSinceRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta="+this.attributes.meta),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.last_update!==null&&(a+="&since="+this.attributes.last_update),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta=0"),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestType:function(a){switch(a){case"all":this.attributes.type="photo&type[]=media&type[]=post";break;case"media":this.attributes.type="media&type[]=photo";break;case"photo":this.attributes.type="photo";break;case"post":this.attributes.type="post"}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1,this.setRequestURL(),this.fetch()},resetContent:function(){this.set({bucket_page:1,content:null},{silent:!0})},startLiveData:function(){var a=this;this.stopLiveData(),this.fetch_interval=setInterval(function(){a.fetch()},1e4)},stopLiveData:function(){clearInterval(this.fetch_interval)}}),SIVVIT.TemporalModel=Backbone.Model.extend({defaults:{startDate:new Date,endDate:new Date,startRange:null,endRange:null,min:null,max:null,histogram:null,histogramStartDate:null,histogramEndDate:null,resolution:"minute"},set:function(a,b){if(a.hasOwnProperty("histogram")&&a.histogram!==undefined&&a.histogram!==null){this.set({histogramStartDate:null}),this.set({histogramEndDate:null});var c=a.histogram.length;if(c>0){var d=0,e=0;for(var f=c;f--;)a.histogram[f].timestamp instanceof Date==!1&&(a.histogram[f].timestamp=Date.secondsToDate(a.histogram[f].timestamp)),this.checkDateBounds(a.histogram[f].timestamp)===!0?(d=Math.min(d,a.histogram[f].count),e=Math.max(e,a.histogram[f].count),!this.get("histogramStartDate")||!this.get("histogramEndDate")?(this.set({histogramStartDate:a.histogram[f].timestamp}),this.set({histogramEndDate:a.histogram[f].timestamp})):(this.set({histogramStartDate:Math.min(a.histogram[f].timestamp,this.get("histogramStartDate"))}),this.set({histogramEndDate:Math.max(a.histogram[f].timestamp,this.get("histogramEndDate"))}))):a.histogram.splice(f,1);a.min=d,a.max=e}this.trigger("change:histogram",this,this.get("histogram"),b)}return Backbone.Model.prototype.set.call(this,a,b),this},adjustResolution:function(a){switch(this.get("resolution")){case"day":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0);case"hour":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),0,0);case"minute":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes());case"second":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())}},adjustToNextBucket:function(a,b){b=b===undefined?this.get("resolution"):b;switch(b){case"day":return Date.plusDay(this.adjustResolution(a));case"hour":return Date.plusHour(this.adjustResolution(a));case"minute":return Date.plusMinute(this.adjustResolution(a));case"second":return Date.plusSecond(this.adjustResolution(a))}},adjustToPrevBucket:function(a,b){b=b===undefined?this.get("resolution"):b;switch(b){case"day":return Date.minusDay(this.adjustResolution(a));case"hour":return Date.minusHour(this.adjustResolution(a));case"minute":return Date.minusMinute(this.adjustResolution(a));case"second":return Date.minusSecond(this.adjustResolution(a))}},getResolution:function(){switch(this.get("resolution")){case"day":return 864e5;case"hour":return 36e5;case"minute":return 6e4;case"second":return 1e3}},checkDateBounds:function(a){return this.adjustToPrevBucket(a,this.get("resolution"))>=this.get("startDate")&&a<=this.get("endDate")?!0:!1}}),SIVVIT.TemporalFrameModel=Backbone.Model.extend({defaults:{count:null,timestamp:null},set:function(a,b){return a.hasOwnProperty("count")&&a.count!==undefined&&a.count!==null&&(a.count=Number(a.count)),Backbone.Model.prototype.set.call(this,a,b),this}}),SIVVIT.ItemModel=Backbone.Model.extend({defaults:{id:null,status:null,type:null,location:[],content:null,source:null,timestamp:null,rank:0,author:null,avatar:null},initialize:function(){this.url=SIVVIT.Settings.host+"/e/post/"+this.get("id")},set:function(a,b){return a.hasOwnProperty("timestamp")&&(a.timestamp=Date.secondsToDate(a.timestamp)),Backbone.Model.prototype.set.call(this,a,b),this},save:function(a){var b=this;$.ajax({url:b.url,data:{status:b.get("status"),id:b.get("id")},type:a.type,dataType:"application/json",success:a.success,complete:a.complete,error:a.error})}}),SIVVIT.ItemGroupModel=Backbone.Model.extend({defaults:{json:null,type:null,id:null,timestamp:null,items:null,items_new:null,div_id:null,displayed:0,stats:{total:0,post:0,media:0}},lock_stats:!1,set:function(a,b){return a.hasOwnProperty("timestamp")&&a.timestamp!==undefined&&a.timestamp!==null&&(a.timestamp=Date.secondsToDate(a.timestamp)),a.hasOwnProperty("stats")&&(this.lock_stats?delete a.stats:this.lock_stats=!0),Backbone.Model.prototype.set.call(this,a,b),this},setRequestPath:function(a,b,c,d,e){var f=Math.round(this.get("displayed")/c)+1;this.url=this.get("json")+"&meta=0&fromDate="+Date.dateToSeconds(a)+"&toDate="+Date.dateToSeconds(b)+"&limit="+c+"&page="+f+"&resolution="+d+"&type[]="+e}}),SIVVIT.HistogramView=Backbone.View.extend({bars:[],histogram:null,initialize:function(a){this.model=a.model,this.model.bind("change:histogram",this.render,this)},render:function(){this.drawHistogram(),this.updateTime()},updateTime:function(){$("#timeline-mintime").html(this.model.get("startRange").format()),$("#timeline-maxtime").html(this.model.get("endRange").format())},drawHistogram:function(){this.histogram&&this.histogram.clear(),this.histogram=new Raphael($(this.el)[0],$(this.el).width(),$(this.el).height());if(this.model.get("histogram")&&this.model.get("histogramStartDate")){var a=this.model.adjustToNextBucket(new Date(this.model.get("histogramEndDate"))).getTime(),b=Math.ceil((a-this.model.get("histogramStartDate"))/this.model.getResolution()),c=this.model.get("histogram").length,d=this.model.get("max"),e=$(this.el).height(),f=$(this.el).width(),g=$(this.el).width()/b;g=g<.5?.5:g;var h=this.model.get("histogramStartDate"),i=a;for(var j=c;j--;)var k=new SIVVIT.TemporalFrameModel(this.model.get("histogram")[j]),l=k.get("count")/d*100,m=(k.get("timestamp").getTime()-h)/(i-h),n=Math.round(l*e/100),o=Math.round(m*f),p=Math.round(e-n),q=this.histogram.rect(o,p,g,n).attr({fill:"#333333","stroke-width":0})}}});