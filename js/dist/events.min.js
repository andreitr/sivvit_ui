typeof SIVVIT=="undefined"&&(SIVVIT={}),SIVVIT.Settings={host:"http://sivvit.com"},function(a,b){b.Events={collection:null,view:null,edit:!0,init:function(a){var c=this;this.collection=new b.EventsCollection,this.view=new b.EventsView({edit:this.edit});var d=Backbone.Model.extend({url:a}),e=new d;e.fetch({success:function(a){$("#content-loader").remove(),$("#event-application").show(),a.attributes&&($.each(a.attributes,function(a,d){var e=new b.EventModel(d);c.collection.add(e)}),c.view.model=c.collection,c.view.render())}})}},b.EventsCollection=Backbone.Collection.extend({model:b.EventModel,comparator:function(a){return-a.get("startDate")}}),b.EventsView=Backbone.View.extend({template:"<li id='post-list'><div id='content'><div id='histogram'></div><div id='title'><a href='${link}'>${title}</a></div><div id='description'>${description}</div><div id='meta'>${posts} posts, ${images} images, ${videos} videos &nbsp; &nbsp;<span class='icon-location'></span>${location} &nbsp;<span class='icon-user'></span><a href='#'>${author}</a></div></div></div></li>",el:"#dynamic-content",models_hash:{},edit:!1,displayed:!1,initialize:function(a){this.edit=a.edit},render:function(){$(this.el).empty(),this.displayed=!1,this.display()},display:function(){$(this.el).append("<ol id='event-list'></ol>"),this.model.each(function(a){a=this.buildTemplate(a);var c=new b.TemporalModel({startDate:a.model.get("startDate"),endDate:a.model.get("last_update"),startRange:a.model.get("startDate"),endRange:a.model.get("last_update"),resolution:a.model.get("histogram").resolution});c.set({histogram:a.model.get("histogram").global});var d=(new b.HistogramView({el:$(a.html).find("#histogram"),model:c})).render();this.initItem(a,"#event-list"),this.models_hash[a.model.get("id")]=a},this),this.initLightbox()},buildTemplate:function(a){var c=$.tmpl(this.template,{link:b.Settings.host+"/event/"+a.get("id"),title:a.get("title"),description:a.get("description"),posts:a.get("stats").posts,videos:a.get("stats").videos,images:a.get("stats").images,location:a.get("location").name,author:a.get("author")});return{html:c,model:a}},initItem:function(a,b){var c=this;a!==null&&(this.edit&&(a.html.find("#content").prepend('<span class="item-edit"><span class=\'icon-cog\' href="event_form.html?id='+a.model.get("id")+'" id=\'event-form\'></span><div id="pending-flag"></div></span>'),a.html.find("#event-form").hide(),a.model.get("pending")>0&&a.html.find("#title").append("<div id='pending'>pending "+a.model.get("pending")+"</div>"),a.html.hover(function(b){a.html.find("#event-form").show()},function(b){a.html.find("#event-form").hide()}),a.html.click(function(b){var c;b.target.id!=="event-form"&&(a.html.find("#itm-check").length>0&&(c=a.html.find("#itm-check").is(":checked"),a.html.find("#itm-check").attr("checked",!c),a.html.css("background-color",c?"#FFFFFF":"#FFFFCC")),b.stopPropagation())}),this.toggleLive(a)),$(b).append(a.html))},initLightbox:function(){var a=this;$("#event-form").fancybox({width:860,height:430,autoScale:!0,scrolling:!1,transitionIn:"fade",transitionOut:"fade",type:"iframe",afterClose:function(){var c=JSON.parse($.cookie("com.sivvit.event"));if(c)switch(c.action){case"delete":a.models_hash[c.model.id]&&a.deleteItem(a.models_hash[c.model.id]);break;case"update":a.models_hash[c.model.id]&&(a.models_hash[c.model.id].model.set(c.model),a.updateItem(a.models_hash[c.model.id]));break;case"create":var d=new b.EventModel(c.model);d.set({last_update:d.get("startDate"),histogram:[]}),a.model.add(d),a.render()}$.cookie("com.sivvit.event",null)}})},deleteItem:function(a){a.html.fadeOut(),this.model.remove(a.model,{silent:!0})},updateItem:function(a){a.html.find("#title").html("<a href='"+b.Settings.host+"/event/"+a.model.get("id")+"'>"+a.model.get("title")+"</a>"),a.html.find("#description").html(a.model.get("description")),this.toggleLive(a)},toggleLive:function(a){var b=a.html.find("#pending-flag");a.model.get("status")===1?(b.toggleClass("idle-notice",!1),b.toggleClass("live-notice",!0)):(b.toggleClass("idle-notice",!0),b.toggleClass("live-notice",!1))}})}($,SIVVIT),Date.prototype.format=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+String(this.getFullYear()).substr(2,2)+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()},Date.secondsToDate=function(a){return new Date(a*1e3)},Date.dateToSeconds=function(a){return Math.round(a.getTime()/1e3)},Date.plusSecond=function(a){return a.getSeconds()===59?Date.plusMinute(new Date(a.setSeconds(0))):new Date(a.setSeconds(a.getSeconds()+1))},Date.plusMinute=function(a){return a.getMinutes()===59?Date.plusHour(new Date(a.setMinutes(0))):new Date(a.setMinutes(a.getMinutes()+1))},Date.plusHour=function(a){return a.getHours()===23?Date.plusDay(new Date(a.setHours(0))):new Date(a.setHours(a.getHours()+1))},Date.plusDay=function(a){return a.getDate()===Date.daysInMonth(a.getMonth(),a.getFullYear())?Date.plusMonth(new Date(a.setDate(1))):new Date(a.setDate(a.getDate()+1))},Date.plusMonth=function(a){return a.getMonth()===11?Date.plusYear(new Date(a.setMonth(0))):new Date(a.setMonth(a.getMonth()+1))},Date.plusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()+1)))},Date.minusSecond=function(a){return a.getSeconds()===0?Date.minusMinute(new Date(a.setSeconds(59))):new Date(a.setSeconds(a.getSeconds()-1))},Date.minusMinute=function(a){return a.getMinutes()===0?Date.minusHour(new Date(a.setMinutes(59))):new Date(a.setMinutes(a.getMinutes()-1))},Date.minusHour=function(a){return a.getHours()===0?Date.minusDay(new Date(a.setHours(23))):new Date(a.setHours(a.getHours()-1))},Date.minusDay=function(a){return a.getDate()===1?Date.minusMonth(new Date(a.setDate(Date.daysInMonth(a.getMonth(),a.getFullYear())))):new Date(a.setDate(a.getDate()-1))},Date.minusMonth=function(a){return a.getMonth()===0?Date.minusYear(new Date(a.setMonth(11))):new Date(a.setMonth(a.getMonth()-1))},Date.minusYear=function(a){return new Date(new Date(a.setFullYear(a.getFullYear()-1)))},Date.daysInMonth=function(a,b){return 32-(new Date(b,a,32)).getDate()},SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,pull:!0,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:null,endDate:null,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},fetch_interval:null,parse:function(a,b){return this.get("status")!==1&&this.get("status")!==0||this.get("pull")!==!0?this.stopLiveData():this.startLiveData(),a},fetch:function(a){this.stopLiveData(),Backbone.Model.prototype.fetch.call(this,a)},set:function(a,b){return a.hasOwnProperty("status")&&a.status!==undefined&&a.status!==null&&(a.status=Number(a.status)),a.hasOwnProperty("startDate")&&(a.startDate=Date.secondsToDate(a.startDate)),a.hasOwnProperty("endDate")&&(a.endDate=Date.secondsToDate(a.endDate)),a.hasOwnProperty("last_update")&&(a.last_update=Date.secondsToDate(a.last_update)),a.hasOwnProperty("histogram")&&a.histogram!==undefined&&a.histogram!==null&&(this.attributes.post_hash=this.attributes.post_hash||{},this.attributes.media_hash=this.attributes.media_hash||{},this.attributes.global_hash=this.attributes.global_hash||{},this.get("histogram")!==undefined&&(a.histogram.max=Math.max(a.histogram.max,this.get("histogram").max),a.histogram.min=Math.min(a.histogram.min,this.get("histogram").min)),a.histogram.post!==undefined&&a.histogram.post!==null?a.histogram.post=this.appendHistogram(this.get("post_hash"),a.histogram.post):a.histogram.post=this.get("histogram")?this.get("histogram").post:null,a.histogram.media!==undefined&&a.histogram.media!==null?a.histogram.media=this.appendHistogram(this.get("media_hash"),a.histogram.media):a.histogram.media=this.get("histogram")?this.get("histogram").media:null,a.histogram.global!==undefined&&a.histogram.global!==null?a.histogram.global=this.appendHistogram(this.get("global_hash"),a.histogram.global):a.histogram.global=this.get("histogram")?this.get("histogram").global:null),Backbone.Model.prototype.set.call(this,a,b),this},createEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/",data:b.formatModel(),type:"POST",dataType:"json",success:a.success,complete:function(a,b){b!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"create",model:JSON.parse(a.responseText)}))},error:a.error})},deleteEvent:function(a){var b=this;a=a||{success:null,complete:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"DELETE",dataType:"json",complete:function(c,d){d!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"delete",model:b.formatModel()})),a.complete(c,d)},error:a.error})},updateEvent:function(a){var b=this;a=a||{success:null,error:null},$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:b.formatModel(),type:"PUT",dataType:"json",success:a.success,error:a.error,complete:function(a,c){c!=="error"&&$.cookie("com.sivvit.event",JSON.stringify({action:"update",model:b.formatModel()}))}})},formatModel:function(){var a={startDate:Date.dateToSeconds(this.get("startDate")),endDate:Date.dateToSeconds(this.get("endDate")),location:this.get("location"),title:this.get("title"),description:this.get("description"),keywords:this.get("keywords"),id:this.get("id")};return a},appendHistogram:function(a,b){var c,d=b.length,e=[];for(c=d;c--;)a[b[c].timestamp]?a[b[c].timestamp].count=Number(a[b[c].timestamp].count)+Number(b[c].count):a[b[c].timestamp]=b[c];for(var f in a)a[f]&&e.push(a[f]);return e},updateContentRange:function(a){this.attributes.content_bounds.min===null&&(this.attributes.content_bounds.min=this.get("endDate"),this.attributes.content_bounds.max=this.get("startDate")),this.attributes.content_bounds.min=Math.min(a,this.attributes.content_bounds.min),this.attributes.content_bounds.max=Math.max(a,this.attributes.content_bounds.max)},setSinceRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta="+this.attributes.meta),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.last_update!==null&&(a+="&since="+this.attributes.last_update),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestURL:function(){var a=this.attributes.json;this.attributes.meta!==null&&(a+="&meta=0"),this.attributes.limit!==null&&(a+="&limit="+this.attributes.limit),this.attributes.bucket_limit!==null&&(a+="&bucket_limit="+this.attributes.bucket_limit),this.attributes.bucket_page!==null&&(a+="&bucket_page="+this.attributes.bucket_page),this.attributes.type!==null&&(a+="&type[]="+this.attributes.type),this.attributes.histogram.resolution!==null&&(a+="&resolution="+this.attributes.histogram.resolution),this.url=a},setRequestType:function(a){switch(a){case"all":this.attributes.type="photo&type[]=media&type[]=post";break;case"media":this.attributes.type="media&type[]=photo";break;case"photo":this.attributes.type="photo";break;case"post":this.attributes.type="post"}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1,this.setRequestURL(),this.fetch()},resetContent:function(){this.set({bucket_page:1,content:null},{silent:!0})},startLiveData:function(){var a=this;this.stopLiveData(),this.fetch_interval=setInterval(function(){a.fetch()},1e4)},stopLiveData:function(){clearInterval(this.fetch_interval)}}),SIVVIT.TemporalModel=Backbone.Model.extend({defaults:{startDate:new Date,endDate:new Date,startRange:null,endRange:null,min:null,max:null,histogram:null,histogramStartDate:null,histogramEndDate:null,resolution:"minute"},set:function(a,b){if(a.hasOwnProperty("histogram")&&a.histogram!==undefined&&a.histogram!==null){this.set({histogramStartDate:null}),this.set({histogramEndDate:null});var c=a.histogram.length;if(c>0){var d=0,e=0;for(var f=c;f--;)a.histogram[f].timestamp instanceof Date==!1&&(a.histogram[f].timestamp=Date.secondsToDate(a.histogram[f].timestamp)),this.checkDateBounds(a.histogram[f].timestamp)===!0?(d=Math.min(d,a.histogram[f].count),e=Math.max(e,a.histogram[f].count),!this.get("histogramStartDate")||!this.get("histogramEndDate")?(this.set({histogramStartDate:a.histogram[f].timestamp}),this.set({histogramEndDate:a.histogram[f].timestamp})):(this.set({histogramStartDate:Math.min(a.histogram[f].timestamp,this.get("histogramStartDate"))}),this.set({histogramEndDate:Math.max(a.histogram[f].timestamp,this.get("histogramEndDate"))}))):a.histogram.splice(f,1);a.min=d,a.max=e}this.trigger("change:histogram",this,this.get("histogram"),b)}return Backbone.Model.prototype.set.call(this,a,b),this},adjustResolution:function(a){switch(this.get("resolution")){case"day":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0);case"hour":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),0,0);case"minute":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes());case"second":return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())}},adjustToNextBucket:function(a,b){b=b===undefined?this.get("resolution"):b;switch(b){case"day":return Date.plusDay(this.adjustResolution(a));case"hour":return Date.plusHour(this.adjustResolution(a));case"minute":return Date.plusMinute(this.adjustResolution(a));case"second":return Date.plusSecond(this.adjustResolution(a))}},adjustToPrevBucket:function(a,b){b=b===undefined?this.get("resolution"):b;switch(b){case"day":return Date.minusDay(this.adjustResolution(a));case"hour":return Date.minusHour(this.adjustResolution(a));case"minute":return Date.minusMinute(this.adjustResolution(a));case"second":return Date.minusSecond(this.adjustResolution(a))}},getResolution:function(){switch(this.get("resolution")){case"day":return 864e5;case"hour":return 36e5;case"minute":return 6e4;case"second":return 1e3}},checkDateBounds:function(a){return this.adjustToPrevBucket(a,this.get("resolution"))>=this.get("startDate")&&a<=this.get("endDate")?!0:!1}}),SIVVIT.TemporalFrameModel=Backbone.Model.extend({defaults:{count:null,timestamp:null},set:function(a,b){return a.hasOwnProperty("count")&&a.count!==undefined&&a.count!==null&&(a.count=Number(a.count)),Backbone.Model.prototype.set.call(this,a,b),this}}),SIVVIT.HistogramView=Backbone.View.extend({bars:[],histogram:null,initialize:function(a){this.model=a.model,this.model.bind("change:histogram",this.render,this)},render:function(){this.drawHistogram(),this.updateTime()},updateTime:function(){$("#timeline-mintime").html(this.model.get("startRange").format()),$("#timeline-maxtime").html(this.model.get("endRange").format())},drawHistogram:function(){this.histogram&&this.histogram.clear(),this.histogram=new Raphael($(this.el)[0],$(this.el).width(),$(this.el).height());if(this.model.get("histogram")&&this.model.get("histogramStartDate")){var a=this.model.adjustToNextBucket(new Date(this.model.get("histogramEndDate"))).getTime(),b=Math.ceil((a-this.model.get("histogramStartDate"))/this.model.getResolution()),c=this.model.get("histogram").length,d=this.model.get("max"),e=$(this.el).height(),f=$(this.el).width(),g=$(this.el).width()/b;g=g<.5?.5:g;var h=this.model.get("histogramStartDate"),i=a;for(var j=c;j--;)var k=new SIVVIT.TemporalFrameModel(this.model.get("histogram")[j]),l=k.get("count")/d*100,m=(k.get("timestamp").getTime()-h)/(i-h),n=Math.round(l*e/100),o=Math.round(m*f),p=Math.round(e-n),q=this.histogram.rect(o,p,g,n).attr({fill:"#333333","stroke-width":0})}}});