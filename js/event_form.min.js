if(typeof SIVVIT=="undefined")SIVVIT={};SIVVIT.Settings={host:"http://sivvit.com"};(function(jQuery,SIVVIT){SIVVIT.EditEvent={model:null,view:null,init:function(id){var self=this;if(id===null||id===undefined){this.model=new SIVVIT.EventModel({startDate:Date.dateToSeconds(new Date),endDate:Date.dateToSeconds(new Date((new Date).getTime()+864E5)),pull:false,meta:0,type:null});self.setLocation()}else this.model=new SIVVIT.EventModel({json:SIVVIT.Settings.host+"/event/"+id+".json?callback=?",pull:false,meta:0,type:null});this.view=new SIVVIT.EditEventView({model:this.model});if(id===
null||id===undefined){this.view.update();this.setDefaultLocation()}else{this.model.setRequestURL();this.model.fetch()}},setLocation:function(){var self=this;if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(position){self.model.set({"location":{"lon":position.coords.latitude,"lat":position.coords.longitude}})});else this.setDefaultLocation()},setDefaultLocation:function(){this.model.set({"location":{"name":"Denver, CO","lat":39.739167,"lon":-104.984722}});this.view.update()}};
SIVVIT.EditEventView=Backbone.View.extend({el:"#form-container",map:null,map_complete:null,events:{"click #save-event-btn":"saveEvent","click #delete-event-btn":"deleteEvent"},initialize:function(options){var self=this;this.model=options.model;this.model.bind("change",this.update,this);this.model.bind("change:location",this.initMap,this)},deleteEvent:function(){},saveEvent:function(){if(this.model.get("id"))this.model.updateEvent();else this.model.createEvent()},update:function(){var slef=this;$("#form-container").show();
$("#content-loader").hide();if(!this.model.get("id")){$(this.el).find("#delete-event-btn").hide();$(this.el).find("#save-event-btn").text("Create New Event")}$("input[name='title']").val(this.model.get("title"));$("input[name='title']").change(function(){slef.model.set({"title":$(this).val()},{silent:true})});$("input[name='location']").val(this.model.get("location").name);$("input[name='keywords']").val(this.model.get("keywords"));$("input[name='keywords']").change(function(){slef.model.set({"keywords":$(this).val().split(",")},
{silent:true})});$("input[name='description']").val(this.model.get("description"));$("input[name='description']").change(function(){slef.model.set({"description":$(this).val()},{silent:true})});$("input[name='start-date']").datetimepicker({dateFormat:"mm/dd/yy",defaultDate:this.model.get("startDate"),hour:this.model.get("startDate").getHours(),minute:this.model.get("startDate").getMinutes(),second:this.model.get("startDate").getSeconds(),onSelect:function(date){slef.model.set({"startDate":Date.dateToSeconds(new Date(date))},
{silent:true})}});$("input[name='end-date']").datetimepicker({dateFormat:"mm/dd/yy",defaultDate:this.model.get("endDate"),hour:this.model.get("endDate").getHours(),minute:this.model.get("endDate").getMinutes(),second:this.model.get("endDate").getSeconds(),onSelect:function(date){slef.model.set({"endDate":Date.dateToSeconds(new Date(date))},{silent:true})}});this.validate()},validate:function(){var self=this;$("#form-main").validate({success:function(label){},errorPlacement:function(error,element){},
highlight:function(element,errorClass){var check=$(self.el).find("#"+$(element).attr("name")+"-check");check.addClass("icon-check-red");check.removeClass("icon-check-green");$(element).css("background-color","#FFFFCC")},unhighlight:function(element,errorClass){var check=$(self.el).find("#"+$(element).attr("name")+"-check");check.removeClass("icon-check-red");check.addClass("icon-check-green");$(element).css("background-color","#FFFFFF")},rules:{title:{required:true,minlength:3},keywords:{required:true,
minlength:3},"start-date":{required:true,date:true},"end-date":{required:true,date:true},location:{required:true,minlength:3}}})},initMap:function(){var self=this;if(!this.map){this.map=new google.maps.Map($("#form-map")[0],{center:new google.maps.LatLng(self.model.get("location").lat,self.model.get("location").lon),zoom:8,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.ROADMAP});this.map_complete=new google.maps.places.Autocomplete($("input[name='location']")[0]);google.maps.event.addListener(this.map_complete,
"place_changed",function(){var place=self.map_complete.getPlace();self.map.setCenter(place.geometry.location);self.model.set({"location":{"lat":place.geometry.location.lat(),"lon":place.geometry.location.lng(),"name":place.name}},{silent:true})})}else this.map.setCenter(new google.maps.LatLng(self.model.get("location").lon,self.model.get("location").lat))}})})($,SIVVIT);Date.prototype.format=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+String(this.getFullYear()).substr(2,2)+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()};Date.secondsToDate=function(seconds){return new Date(seconds*1E3)};Date.dateToSeconds=function(date){return Number(date.getTime()/1E3)};SIVVIT.EventModel=Backbone.Model.extend({defaults:{json:null,meta:1,limit:3,bucket_limit:5,bucket_page:1,pull:true,type:"post",content_bounds:{min:null,max:null},id:null,title:null,author:null,description:null,keywords:[],content:[],location:{lon:null,lat:null,name:null},startDate:null,endDate:null,status:0,last_update:null,pending:0,stats:{total:0,posts:0,images:0,videos:0},histogram:{min:null,max:null,resolution:null,global:[],media:[],post:[]}},post_hash:{},media_hash:{},global_hash:{},fetch_interval:null,
initialize:function(){this.bind("change",function(){if(this.get("status")===1&&this.get("pull")===true)this.startLiveData();else this.stopLiveData()},this)},fetch:function(options){this.stopLiveData();Backbone.Model.prototype.fetch.call(this,options)},set:function(attributes,options){if(attributes.hasOwnProperty("status")&&attributes.histogram!==undefined&&attributes.histogram!==null)attributes.status=Number(attributes.status);if(attributes.hasOwnProperty("startDate"))attributes.startDate=Date.secondsToDate(attributes.startDate);
if(attributes.hasOwnProperty("endDate"))attributes.endDate=Date.secondsToDate(attributes.endDate);if(attributes.hasOwnProperty("last_update"))attributes.last_update=Date.secondsToDate(attributes.last_update);if(attributes.hasOwnProperty("histogram")&&attributes.histogram!==undefined&&attributes.histogram!==null){if(this.get("histogram")!==undefined){attributes.histogram.max=Math.max(attributes.histogram.max,this.get("histogram").max);attributes.histogram.min=Math.min(attributes.histogram.min,this.get("histogram").min)}if(attributes.histogram.post!==
undefined&&attributes.histogram.post!==null)attributes.histogram.post=this.appendHistogram(this.post_hash,attributes.histogram.post);if(attributes.histogram.media!==undefined&&attributes.histogram.media!==null)attributes.histogram.media=this.appendHistogram(this.media_hash,attributes.histogram.media);if(attributes.histogram.global!==undefined&&attributes.histogram.global!==null)attributes.histogram.global=this.appendHistogram(this.global_hash,attributes.histogram.global)}Backbone.Model.prototype.set.call(this,
attributes,options);return this},createEvent:function(init){var self=this;$.ajax({url:SIVVIT.Settings.host+"/e/event/",data:self.formatModel(),type:"POST",dataType:"json",success:init.success,complete:init.complete,error:init.error})},updateEvent:function(){var self=this;$.ajax({url:SIVVIT.Settings.host+"/e/event/"+this.get("id"),data:self.formatModel(),type:"PUT",dataType:"json"})},formatModel:function(){var result={startDate:Date.dateToSeconds(this.get("startDate")),endDate:Date.dateToSeconds(this.get("endDate")),
location:this.get("location"),title:this.get("title"),description:this.get("description"),keywords:this.get("keywords")};return result},appendHistogram:function(hash,value){var len=value.length;var result=[];for(var i=len;i--;)if(hash[value[i].timestamp])hash[value[i].timestamp].count=Number(hash[value[i].timestamp].count)+Number(value[i].count);else hash[value[i].timestamp]=value[i];for(var bucket in hash)if(hash[bucket])result.push(hash[bucket]);return result},updateContentRange:function(date){if(this.attributes.content_bounds.min===
null){this.attributes.content_bounds.min=this.get("endDate");this.attributes.content_bounds.max=this.get("startDate")}this.attributes.content_bounds.min=Math.min(date,this.attributes.content_bounds.min);this.attributes.content_bounds.max=Math.max(date,this.attributes.content_bounds.max)},hasMoreContent:function(){if(this.get("content_bounds").min>this.get("startDate"))return true;else return false},setSinceRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta="+
this.attributes.meta;if(this.attributes.limit!==null)path+="&limit="+this.attributes.limit;if(this.attributes.last_update!==null)path+="&since="+this.attributes.last_update;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+this.attributes.bucket_limit;if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==null)path+="&resolution="+this.attributes.histogram.resolution;
else path+="&resolution=hour";this.url=path},setRequestURL:function(){var path=this.attributes.json;if(this.attributes.meta!==null)path+="&meta=0";if(this.attributes.limit!==null)path+="&limit="+this.attributes.limit;if(this.attributes.bucket_limit!==null)path+="&bucket_limit="+this.attributes.bucket_limit;if(this.attributes.bucket_page!==null)path+="&bucket_page="+this.attributes.bucket_page;if(this.attributes.type!==null)path+="&type[]="+this.attributes.type;if(this.attributes.histogram.resolution!==
null)path+="&resolution="+this.attributes.histogram.resolution;this.url=path},setRequestType:function(type){switch(type){case "all":this.attributes.type="photo&type[]=media&type[]=post";break;case "media":this.attributes.type="media&type[]=photo";break;case "photo":this.attributes.type="photo";break;case "post":this.attributes.type="post";break}},loadMoreContent:function(){this.attributes.bucket_page=this.get("bucket_page")+1;this.setRequestURL();this.fetch()},startLiveData:function(){var self=this;
this.stopLiveData();this.fetch_interval=setInterval(function(){self.fetch()},1E4)},stopLiveData:function(){clearInterval(this.fetch_interval)}});